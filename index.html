<script>
    const firebaseConfig = { 
        apiKey: "AIzaSyD3hc6Rz1gHZq8c71AHp5NSw8eSZT2-Mik", 
        authDomain: "savitri-job-bridge.firebaseapp.com", 
        projectId: "savitri-job-bridge", 
        storageBucket: "savitri-job-bridge.firebasestorage.app", 
        messagingSenderId: "721066136910", 
        appId: "1:721066136910:web:61b5d58b31d8ab481f7a1f" 
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // SMART MEMORY
    let userRole = localStorage.getItem('rozgaarRole') || 'new';
    let myPhone = localStorage.getItem('rozgaarPhone') || '';

    window.addEventListener('load', () => setTimeout(() => { 
        document.getElementById('intro-overlay').style.display = 'none'; 
        document.getElementById('main-content').style.display = 'block';
        updateMenuLabels(); 
    }, 2000));

    function updateMenuLabels() {
        const dashBtn = document.getElementById('dashLink');
        if(userRole === 'seeker') dashBtn.innerText = "üìä My Work Place";
        else if(userRole === 'employer') dashBtn.innerText = "üìä My Staff";
        else dashBtn.innerText = "üìä Dashboard";
    }

    function switchSection(sec) {
        document.getElementById('app-section').style.display = sec === 'app' ? 'block' : 'none';
        document.getElementById('dashboard-section').style.display = sec === 'dashboard' ? 'block' : 'none';
        document.getElementById('myDropdown').classList.remove('show-menu');
        if(sec === 'dashboard') {
            if(userRole === 'new') {
                Swal.fire({ icon: 'info', text: 'Pehle profile banayein!', background:'#111827', color:'#fff' });
                switchSection('app');
            } else {
                loadSmartDashboard();
            }
        }
    }

    // ORIGINAL SMART DASHBOARD LOGIC
    async function loadSmartDashboard() {
        const container = document.getElementById('roleContent');
        const title = document.getElementById('dashTitle');
        container.innerHTML = "<p style='text-align:center; opacity:0.5;'>Loading Secure Data...</p>";

        if(userRole === 'employer') {
            title.innerText = "My Hired Staff Tracker";
            db.collection("JobSeekers").where("employerContact", "==", myPhone).onSnapshot(snap => {
                let h = "";
                snap.forEach(doc => {
                    const d = doc.data();
                    h += `<div class="candidate-card animate__animated animate__fadeIn">
                            <b>üë§ Staff: ${d.name}</b><br>
                            <span class="status-badge" style="background:var(--primary)">${d.dealStatus || 'Request Pending'}</span>
                            <div style="display:flex; gap:10px; margin-top:12px;">
                                <a href="tel:${d.phone}" class="btn-main" style="flex:1; background:var(--primary); padding:10px; font-size:11px; text-decoration:none; text-align:center;">üìû Call</a>
                                <button onclick="updateDeal('${doc.id}', 'Cancelled')" class="btn-main" style="flex:0.5; background:var(--danger); padding:10px; font-size:11px;">Remove</button>
                            </div>
                        </div>`;
                });
                container.innerHTML = h || "<p style='text-align:center;'>Koi staff hired nahi hai.</p>";
            });
        } else {
            title.innerText = "Job Offers for Me";
            db.collection("JobSeekers").where("phone", "==", myPhone).onSnapshot(snap => {
                let h = "";
                snap.forEach(doc => {
                    const d = doc.data();
                    if(d.hireRequestedBy) {
                        h += `<div class="candidate-card animate__animated animate__fadeIn" style="border-left:4px solid var(--success);">
                                <b>üè¢ Shop: ${d.hireRequestedBy}</b><br>
                                <small>üìç ${d.employerAddress}</small>
                                <div style="display:flex; gap:10px; margin-top:12px;">
                                    <a href="tel:${d.employerContact}" class="btn-main" style="flex:1; background:var(--primary); padding:10px; font-size:11px; text-decoration:none; text-align:center;">üìû Call</a>
                                    <a href="https://wa.me/91${d.employerContact}" class="btn-main" style="flex:1; background:#25D366; padding:10px; font-size:11px; text-decoration:none; text-align:center;">üí¨ WhatsApp</a>
                                </div>
                            </div>`;
                    }
                });
                container.innerHTML = h || "<p style='text-align:center;'>Abhi tak koi offer nahi aaya.</p>";
            });
        }
    }

    function saveData() {
        const phone = document.getElementById('sPhone').value;
        if(!phone) { Swal.fire({text:'Number daalein!'}); return; }
        
        // Save Role as Seeker
        localStorage.setItem('rozgaarRole', 'seeker');
        localStorage.setItem('rozgaarPhone', phone);
        myPhone = phone;

        const data = { 
            name: document.getElementById('sName').value, 
            phone: phone,
            skill: document.getElementById('sSkill').value.toLowerCase().trim(), 
            location: document.getElementById('sLocation').value, 
            salary: Number(document.getElementById('sSalary').value),
            status: "Available", time: new Date() 
        };
        db.collection("JobSeekers").add(data).then(() => { 
            Swal.fire({icon:'success', title:'Profile Live! üöÄ'}).then(() => location.reload()); 
        });
    }

    function requestHire(sid) {
        const ec = document.getElementById('empPhone').value;
        if(!ec) { Swal.fire({text: 'Pehle shop details bharein!'}); return; }

        // Save Role as Employer
        localStorage.setItem('rozgaarRole', 'employer');
        localStorage.setItem('rozgaarPhone', ec);
        myPhone = ec;

        db.collection("JobSeekers").doc(sid).update({ 
            hireRequestedBy: document.getElementById('empCompany').value, 
            employerContact: ec, 
            employerAddress: document.getElementById('empAddress').value,
            dealStatus: 'Pending'
        }).then(() => Swal.fire({ icon:'success', title:'Requested! üéä' }));
    }

    function updateDeal(id, status) {
        db.collection("JobSeekers").doc(id).update({ hireRequestedBy: null, employerContact: null, dealStatus: null }).then(() => {
            Swal.fire({ icon:'success', title: 'Updated' });
        });
    }
</script>
